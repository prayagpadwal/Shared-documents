CREATE PROCEDURE dbo.Report_PDCProgramData
    @WeekFilter INT,
    @ActualsFilter DATE,
    @RAG_MIN_Threshold DECIMAL(6,2),
    @RAG_MAX_Threshold DECIMAL(6,2),
    @Output VARCHAR(40),
    @Year INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Normalize notifications
    WITH WPML_Actuals AS (
        SELECT 
            [PDC Program],
            SUM(CASE WHEN [Project Reporting Year] = @Year THEN [Initiation Actuals] ELSE 0 END) AS [Initiation Actuals],
            SUM(CASE WHEN [Project Reporting Year] = @Year THEN [Design Actuals] ELSE 0 END) AS [Design Actuals],
            SUM(CASE WHEN [Project Reporting Year] = @Year THEN [Dependency Actuals] ELSE 0 END) AS [Dependency Actuals],
            SUM(CASE WHEN [Project Reporting Year] = @Year THEN [Execute Actuals] ELSE 0 END) AS [Execute Actuals],
            SUM(CASE WHEN [Project Reporting Year] = @Year THEN [In Workplan] ELSE 0 END) AS [In Workplan]
        FROM BSA.dbo.vw_WPML_PDC_IDDSEC
        WHERE [Project Reporting Year] = @Year
        GROUP BY [PDC Program]
    ),

    -- Combine actuals with DOT actuals if necessary
    IDDSEC_Actuals AS(
        SELECT 
            [PDC Program],
            SUM([Initiation Actuals]) AS [Initiation Actuals],
            SUM([Design Actuals]) AS [Design Actuals],
            SUM([Dependency Actuals]) AS [Dependency Actuals],
            SUM([Execute Actuals]) AS [Execute Actuals],
            SUM([In Workplan]) AS [Total in Workplan]
        FROM WPML_Actuals
        GROUP BY [PDC Program]
    ),

    -- Extract targets for the specific week
    IDDE_DOT AS (
        SELECT 
            [PDC Program],
            SUM(ISNULL([Initiation YTD Target], 0)) AS [Initiation Target],
            SUM(ISNULL([Design YTD Target], 0)) AS [Design Target],
            SUM(ISNULL([Dependency YTD Target], 0)) AS [Dependency Target],
            SUM(ISNULL([Execute YTD Target], 0)) AS [Execute Target]
        FROM bsa.dbo.vw_NewWOR_PDCTargets_2024
        WHERE [FULL Week Number] = @WeekFilter
        GROUP BY [PDC Program]
    ),

    -- Calculate Rebaseline data
    DOT_Rebaseline AS (
        SELECT 
            [PDC Program],
            SUM(ISNULL([Rebaseline], 0)) AS [Rebaseline]
        FROM ada.Delivery.DOT_Unit_Forecast_Comp
        WHERE [Date Range] LIKE '%' + CAST(@Year AS VARCHAR) + '%'
        GROUP BY [PDC Program]
    )

    -- Output the final results
    SELECT
        @Output AS [Output],
        act.[PDC Program] AS [Program],
        dot.[Initiation Target] AS [Initiation Plan],
        act.[Initiation Actuals] AS [Initiation Actuals],
        ROUND(ISNULL(act.[Initiation Actuals], 0) / NULLIF(dot.[Initiation Target], 0), 2) AS [Initiation % to Plan],
        dot.[Design Target] AS [Design Plan],
        act.[Design Actuals] AS [Design Actuals],
        ROUND(ISNULL(act.[Design Actuals], 0) / NULLIF(dot.[Design Target], 0), 2) AS [Design % to Plan],
        dot.[Dependency Target] AS [Dependency Plan],
        act.[Dependency Actuals] AS [Dependency Actuals],
        ROUND(ISNULL(act.[Dependency Actuals], 0) / NULLIF(dot.[Dependency Target], 0), 2) AS [Dependency % to Plan],
        dot.[Execute Target] AS [Execute Plan],
        act.[Execute Actuals] AS [Execute Actuals],
        ROUND(ISNULL(act.[Execute Actuals], 0) / NULLIF(dot.[Execute Target], 0), 2) AS [Execute % to Plan],
        reb.[Rebaseline] AS [Rebaseline Completions]
    FROM IDDE_DOT dot
    LEFT JOIN IDDSEC_Actuals act ON act.[PDC Program] = dot.[PDC Program]
    LEFT JOIN DOT_Rebaseline reb ON reb.[PDC Program] = dot.[PDC Program]
    ORDER BY act.[PDC Program];

    SET NOCOUNT OFF;
END
GO
